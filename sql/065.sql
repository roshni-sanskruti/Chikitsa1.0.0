CREATE OR REPLACE VIEW %dbprefix%view_report AS SELECT appointment.appointment_id AS appointment_id,appointment.patient_id AS patient_id,appointment.clinic_code AS clinic_code,CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''),' ',IFNULL(view_patient.last_name,'')) AS patient_name,appointment.doctor_id AS doctor_id,appointment.clinic_id AS clinic_id,appointment.status AS status,clinic.clinic_name AS clinic_name,CONCAT(IFNULL(contacts.first_name,''),' ',IFNULL(contacts.middle_name,''),' ',IFNULL(contacts.last_name,'')) AS doctor_name,appointment.appointment_date AS appointment_date,MIN(appointment.start_time) AS appointment_time,MAX((CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END)) AS waiting_in,(MAX((CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)) - MAX((CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END))) AS waiting_duration,MAX((CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)) AS consultation_in,MAX((CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END)) AS consultation_out,(MAX((CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END)) - MAX((CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END))) AS consultation_duration,MAX((CASE appointment_log.old_status WHEN 'Consultation' THEN timediff(appointment_log.to_time,appointment_log.from_time) END)) AS waiting_out,MAX(bill.total_amount) AS collection_amount FROM %dbprefix%appointments appointment LEFT JOIN %dbprefix%view_patient view_patient ON appointment.patient_id = view_patient.patient_id LEFT JOIN %dbprefix%bill bill ON appointment.visit_id = bill.visit_id LEFT JOIN %dbprefix%appointment_log appointment_log ON appointment.appointment_id = appointment_log.appointment_id LEFT JOIN %dbprefix%doctor doctor ON doctor.doctor_id = appointment.doctor_id LEFT JOIN %dbprefix%contacts contacts ON contacts.contact_id = doctor.contact_id LEFT JOIN %dbprefix%clinic clinic ON clinic.clinic_id = appointment.clinic_id GROUP BY appointment.appointment_id,CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''),' ',IFNULL(view_patient.last_name,'')) ;
CREATE TABLE %dbprefix%tax_rates ( tax_id int(11) NOT NULL, tax_rate_name varchar(25) NOT NULL, tax_rate decimal(10,2) NOT NULL) ;
ALTER TABLE %dbprefix%visit ADD clinic_code VARCHAR(6) NULL AFTER sync_status;
INSERT INTO %dbprefix%navigation_menu (menu_name, parent_name, menu_order, menu_url, menu_icon, menu_text, required_module, is_deleted, sync_status) VALUES ('tax_report', 'reports', '600', 'bill/tax_report', NULL, 'tax_report', NULL, NULL, NULL);
ALTER TABLE %dbprefix%bill ADD tax_amount DECIMAL(10,2) NOT NULL DEFAULT '0';
ALTER TABLE %dbprefix%bill_detail ADD tax_amount DECIMAL(10,2) NULL DEFAULT '0';
CREATE OR REPLACE VIEW %dbprefix%view_bill_tax_report  AS SELECT patient.display_id AS display_id,patient.first_name AS first_name,patient.middle_name AS middle_name,patient.last_name AS last_name,bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.tax_amount AS tax_amount,bill.total_amount AS total_amount FROM %dbprefix%bill bill JOIN %dbprefix%view_patient patient ON patient.patient_id = bill.patient_id ;
CREATE OR REPLACE VIEW %dbprefix%view_tax_report  AS  SELECT patient.display_id AS display_id, patient.first_name AS first_name, patient.middle_name AS middle_name, patient.last_name AS last_name, bill.bill_id AS bill_id, bill.bill_date AS bill_date, SUM(IFNULL(bill_detail_tax.amount,0)) AS taxable_amount, SUM(IFNULL(bill_detail_non.amount,0)) AS non_taxable_amount, bill.tax_amount AS tax_amount, bill.total_amount AS total_amount  FROM %dbprefix%bill bill  LEFT JOIN %dbprefix%bill_detail bill_detail_tax ON bill_detail_tax.bill_id = bill.bill_id AND IFNULL(bill_detail_tax.tax_amount,0) > 0  LEFT JOIN %dbprefix%bill_detail bill_detail_non ON bill_detail_non.bill_id = bill.bill_id AND IFNULL(bill_detail_non.tax_amount,0) = 0  JOIN %dbprefix%view_patient patient on patient.patient_id = bill.patient_id ;
INSERT INTO %dbprefix%tax_rates (tax_id, tax_rate_name, tax_rate) VALUES (1, 'No Tax', '0.00');
CREATE OR REPLACE VIEW %dbprefix%view_bill_detail_report  AS SELECT bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.visit_id AS visit_id,bill_detail.particular AS particular,bill_detail.amount AS amount,bill_detail.tax_amount AS tax_amount,visit.userid AS userid,CONCAT(view_patient.first_name,' ',view_patient.middle_name,' ',view_patient.last_name) AS patient_name,view_patient.display_id AS display_id,bill_detail.type AS type FROM %dbprefix%bill bill LEFT JOIN %dbprefix%bill_detail bill_detail ON bill_detail.bill_id = bill.bill_id LEFT JOIN %dbprefix%visit visit ON visit.visit_id = bill.visit_id LEFT JOIN %dbprefix%view_patient view_patient ON view_patient.patient_id = bill.patient_id WHERE IFNULL(bill_detail.is_deleted,0) <> 1;
INSERT INTO %dbprefix%navigation_menu (menu_name, parent_name, menu_order, menu_url, menu_icon, menu_text) VALUES ( 'tax_rates', 'administration', '700', 'settings/tax_rates', NULL, 'tax_rates');
UPDATE %dbprefix%navigation_menu SET menu_text = 'tax_rates' WHERE menu_name = 'tax_rates';
ALTER TABLE %dbprefix%bill CHANGE total_amount total_amount DECIMAL(10,2) NOT NULL DEFAULT '0';
CREATE OR REPLACE VIEW %dbprefix%view_bill AS SELECT bill.bill_id AS bill_id,		bill.bill_date AS bill_date,		bill.visit_id AS visit_id,		doctor.name AS doctor_name,		visit.doctor_id AS doctor_id,		visit.clinic_id AS clinic_id,		clinic.clinic_name AS clinic_name,		patient.patient_id AS patient_id,		patient.display_id AS display_id,		contacts.first_name AS first_name,		contacts.middle_name AS middle_name,		contacts.last_name AS last_name,		bill.total_amount AS total_amount,		IFNULL(bill.tax_amount,0) AS tax_amount,		bill.due_amount AS due_amount, SUM(bill_payment_r.adjust_amount) AS pay_amount FROM %dbprefix%bill bill JOIN %dbprefix%visit visit ON bill.visit_id = visit.visit_id LEFT JOIN %dbprefix%clinic clinic ON clinic.clinic_id = bill.clinic_id JOIN %dbprefix%patient patient ON bill.patient_id = patient.patient_id JOIN %dbprefix%contacts contacts ON contacts.contact_id = patient.contact_id JOIN %dbprefix%view_doctor doctor ON visit.doctor_id = doctor.doctor_id LEFT JOIN %dbprefix%bill_payment_r bill_payment_r ON bill_payment_r.bill_id = bill.bill_id GROUP BY bill.bill_id,doctor.name,visit.userid,patient.patient_id;
UPDATE %dbprefix%receipt_template SET template = '<h1 style="text-align: center;">[clinic_name]</h1><h2 style="text-align: center;">[tag_line]</h2><p style="text-align: center;">[clinic_address]</p><p style="text-align: center;"><strong style="line-height: 1.42857143;">Landline : </strong><span style="line-height: 1.42857143;">[landline]</span> <strong style="line-height: 1.42857143;">Mobile : </strong><span style="line-height: 1.42857143;">[mobile]</span> <strong style="line-height: 1.42857143;">Email : </strong><span style="text-align: center;"> [email]</span></p><hr id="null" /><h3 style="text-align: center;"><u style="text-align: center;">RECEIPT</u></h3><p><span style="text-align: left;"><strong>Date : </strong>[bill_date] [bill_time]</span><span style="float: right;"><strong>Receipt Number :</strong> [bill_id]</span></p><p style="text-align: left;"><strong style="text-align: left;">Patient Name: </strong><span style="text-align: left;">[patient_name]<br /></span></p><hr id="null" style="text-align: left;" /><p>Received fees for Professional services and other charges of our:</p><p>&nbsp;</p><p>&nbsp;</p><table style="width: 100%; margin-top: 25px; margin-bottom: 25px; border-collapse: collapse; border: 1px solid black;"><thead><tr><td style="width: 400px; text-align: left; padding: 5px; border: 1px solid black;"><strong style="width: 400px; text-align: left;">Item</strong></td><td style="padding: 5px; border: 1px solid black;"><strong>Quantity</strong></td><td style="width: 100px; text-align: right; padding: 5px; border: 1px solid black;"><strong>M.R.P.</strong></td><td style="width: 100px; text-align: right; padding: 5px; border: 1px solid black;"><strong>Amount</strong></td></tr></thead><tbody><tr><td colspan="4">[col:particular|quantity|mrp|amount]</td></tr><tr><td style="padding: 5px; border: 1px solid black;" colspan="3">Discount</td><td style="text-align: right; padding: 5px; border: 1px solid black;"><strong>[discount]</strong></td></tr><tr><td>[tax_details]</td></tr><tr><td style="padding: 5px; border: 1px solid black;" colspan="3">Total</td><td style="text-align: right; padding: 5px; border: 1px solid black;"><strong>[total]</strong></td></tr><tr><td style="padding: 5px; border: 1px solid black;" colspan="3">Paid Amount</td><td style="text-align: right; padding: 5px; border: 1px solid black;">[paid_amount]</td></tr></tbody></table>p>Received with Thanks,</p><p>For [clinic_name]</p><p>&nbsp;</p><p>&nbsp;</p><p>Signature</p>' WHERE type='bill' AND is_default = 1;
UPDATE %dbprefix%version SET current_version='0.6.5';