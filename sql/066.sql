CREATE OR REPLACE VIEW %dbprefix%view_tax_report  AS  SELECT patient.display_id AS display_id,		patient.first_name AS first_name,		patient.middle_name AS middle_name,		patient.last_name AS last_name,		bill.bill_id AS bill_id,        bill.bill_date AS bill_date,		sum(ifnull(bill_detail_tax.amount,0)) AS taxable_amount,		sum(ifnull(bill_detail_non.amount,0)) AS non_taxable_amount,		sum(ifnull(bill_detail_tax.tax_amount,0)) AS tax_amount,		bill.total_amount AS total_amount   FROM %dbprefix%bill bill        JOIN %dbprefix%view_patient patient on patient.patient_id = bill.patient_id       LEFT JOIN %dbprefix%bill_detail bill_detail_tax on bill_detail_tax.bill_id = bill.bill_id  and ifnull(bill_detail_tax.tax_amount,0) > 0		LEFT JOIN %dbprefix%bill_detail bill_detail_non on bill_detail_non.bill_id = bill.bill_id and ifnull(bill_detail_non.tax_amount,0) = 0 GROUP BY bill.bill_id;
CREATE OR REPLACE VIEW %dbprefix%view_bill_tax_report AS select patient.display_id AS display_id, patient.first_name AS first_name,patient.middle_name AS middle_name,patient.last_name AS last_name,bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.total_amount AS total_amount,SUM(bill_detail.amount) AS tax_amountfrom %dbprefix%bill bill  join %dbprefix%view_patient patient on patient.patient_id = bill.patient_id left join %dbprefix%bill_detail bill_detail on bill_detail.bill_id = bill.bill_id AND bill_detail.type='tax' group by bill.bill_id;
CREATE OR REPLACE VIEW %dbprefix%view_bill AS select bill.bill_id AS bill_id,bill.bill_date AS bill_date,bill.visit_id AS visit_id,doctor.name AS doctor_name,visit.doctor_id AS doctor_id,visit.clinic_id AS clinic_id,linic.clinic_name AS clinic_name,patient.patient_id AS patient_id,patient.display_id AS display_id,contacts.first_name AS first_name,contacts.middle_name AS middle_name,contacts.last_name AS last_name,bill.total_amount AS total_amount,ifnull(bill.tax_amount,0) AS item_tax_amount,sum(bill_detail.amount) AS bill_tax_amount,bill.due_amount AS due_amount,(SELECT sum(bill_payment_r.adjust_amount) FROM  %dbprefix%bill_payment_r bill_payment_r WHERE bill_payment_r.bill_id = bill.bill_id) AS pay_amount from %dbprefix%bill bill left join %dbprefix%visit visit on bill.visit_id = visit.visit_id left join %dbprefix%clinic clinic on clinic.clinic_id = bill.clinic_id left join %dbprefix%patient patient on bill.patient_id = patient.patient_id left join %dbprefix%contacts contacts on contacts.contact_id = patient.contact_id left join %dbprefix%view_doctor doctor on visit.doctor_id = doctor.doctor_id left join %dbprefix%bill_detail bill_detail on bill_detail.bill_id = bill.bill_id and bill_detail.type = 'tax' group by bill.bill_id,doctor.name,visit.userid,patient.patient_id;
CREATE OR REPLACE VIEW %dbprefix%view_visit AS select visit.visit_id AS visit_id,visit.visit_date AS visit_date,visit.visit_time AS visit_time,visit.type AS type,visit.notes AS notes,visit.patient_notes AS patient_notes,visit.doctor_id AS doctor_id,doctor.name AS name,visit.patient_id AS patient_id,bill.bill_id AS bill_id,bill.total_amount AS total_amount,(SELECT SUM(bill_detail.amount) FROM %dbprefix%bill_detail AS bill_detail ON bill_detail.bill_id = bill.bill_id AND bill_detail.type='tax') AS bill_tax_amount,bill.due_amount AS due_amount from %dbprefix%visit visit join %dbprefix%view_doctor doctor on doctor.doctor_id = visit.doctor_id join %dbprefix%bill bill on bill.visit_id = visit.visit_id order by visit.patient_id,visit.visit_date,visit.visit_time;
INSERT INTO %dbprefix%receipt_template (template,is_default,template_name,type) VALUES ('<h1 style="text-align: center;">[clinic_name]</h1><h2 style="text-align: center;">[tag_line]</h2><p style="text-align: center;">[clinic_address]</p><p style="text-align: center;"><strong style="line-height: 1.42857143;">Landline : </strong><span style="line-height: 1.42857143;">[landline]</span> <strong style="line-height: 1.42857143;">Mobile : </strong><span style="line-height: 1.42857143;">[mobile]</span> <strong style="line-height: 1.42857143;">Email : </strong><span style="text-align: center;"> [email]</span></p><hr id="null" /><h3 style="text-align: center;"><u style="text-align: center;">RECEIPT</u></h3><p><span style="text-align: left;"><strong>Date : </strong>[bill_date] [bill_time]</span><span style="float: right;"><strong>Receipt Number :</strong> [bill_id]</span></p><p style="text-align: left;"><strong style="text-align: left;">Patient Name: </strong><span style="text-align: left;">[patient_name]<br /></span></p><hr id="null" style="text-align: left;" /><p>Received fees for Professional services and other charges of our:</p><p>&nbsp;</p><p>&nbsp;</p><table style="width: 100%; margin-top: 25px; margin-bottom: 25px; border-collapse: collapse; border: 1px solid black;"><thead><tr><td style="width: 400px; text-align: left; padding: 5px; border: 1px solid black;"><strong style="width: 400px; text-align: left;">Item</strong></td><td style="padding: 5px; border: 1px solid black;"><strong>Quantity</strong></td><td style="width: 100px; text-align: right; padding: 5px; border: 1px solid black;"><strong>M.R.P.</strong></td><td style="width: 100px; text-align: right; padding: 5px; border: 1px solid black;"><strong>Amount</strong></td>[tax_column_header]</tr></thead><tbody><tr><td colspan="4">[col:particular|quantity|mrp|amount|tax_amount]</td></tr><tr><td style="padding: 5px; border: 1px solid black;" colspan="3">Discount</td><td style="text-align: right; padding: 5px; border: 1px solid black;"><strong>[discount]</strong></td></tr><tr><td>[tax_details]</td></tr><tr><td style="padding: 5px; border: 1px solid black;" colspan="3">Total</td><td style="text-align: right; padding: 5px; border: 1px solid black;"><strong>[total]</strong></td></tr><tr><td style="padding: 5px; border: 1px solid black;" colspan="3">Paid Amount</td><td style="text-align: right; padding: 5px; border: 1px solid black;">[paid_amount]</td></tr></tbody></table><p>Received with Thanks,</p><p>For [clinic_name]</p><p>&nbsp;</p><p>&nbsp;</p><p>Signature</p>', 1, 'Main with Tax','bill');
UPDATE %dbprefix%versiON SET current_version='0.6.6';