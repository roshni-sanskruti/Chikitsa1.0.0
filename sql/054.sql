ALTER TABLE %dbprefix%user_categories CHANGE category_name category_name VARCHAR(50) NULL DEFAULT NULL;
INSERT INTO %dbprefix%user_categories (category_name) VALUES ('System Administrator');
ALTER TABLE %dbprefix%users CHANGE level level VARCHAR(25) NOT NULL;
INSERT INTO %dbprefix%users (name,username,password,level, is_active) VALUES ('System Administrator', 'sysadmin', 'Q2hpa2l0c2Eh', 'System Administrator', '1');
INSERT INTO %dbprefix%menu_access(menu_name, category_name, allow) SELECT menu_name,'System Administrator',1 FROM %dbprefix%navigation_menu;
INSERT INTO %dbprefix%menu_access(menu_name, category_name, allow) SELECT menu_name,'Administrator',1 FROM %dbprefix%navigation_menu WHERE menu_name NOT IN ('backup','clinic_detail');
CREATE TABLE IF NOT EXISTS %dbprefix%doctor (  doctor_id int(11) NOT NULL AUTO_INCREMENT,  contact_id int(11) NOT NULL, degree varchar(150) NULL, specification varchar(300) NULL,experience varchar(300) NULL, joining_date date NULL, licence_number varchar(50) NULL,  department_id int(11) NULL,  gender varchar(10) NULL,userid VARCHAR(16) NULL , PRIMARY KEY (doctor_id));
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'software_name', 'Chikitsa');
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'copyright_text', '&copy; 2017 Sanskruti Technologies');
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'copyright_url', 'http://sanskruti.net/ ');
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'website_text', 'Chikitsa');
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'website_url', 'http://chikitsa.sanskruti.net/ ');
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'support_text', 'Support Forum');
INSERT INTO %dbprefix%data (ck_key, ck_value) VALUES ( 'support_url', 'http://sanskruti.net/chikitsa/support-2/');
CREATE OR REPLACE VIEW %dbprefix%view_report AS SELECT clinic.clinic_name,       clinic.clinic_id,       appointment.appointment_id,        appointment.patient_id, 	   CONCAT(IFNULL(view_patient.first_name,''),' ',IFNULL(view_patient.middle_name,''), ' ',IFNULL(view_patient.last_name,'')) as patient_name, 	   appointment.userid,	   users.name doctor_name,	   appointment.appointment_date,			   min(appointment.start_time) as appointment_time,			   max(CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END) as waiting_in,			   max(CASE appointment_log.old_status WHEN 'Consultation' THEN timediff(appointment_log.from_time,appointment_log.to_time) END) as waiting_out,			   TIMEDIFF((max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END)),(max(CASE appointment_log.status WHEN 'Waiting' THEN appointment_log.from_time END))) as waiting_duration, 		max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END) as consultation_in,			   max(CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END) as consultation_out,		TIMEDIFF((max(CASE appointment_log.status WHEN 'Complete' THEN appointment_log.from_time END)),(max(CASE appointment_log.status WHEN 'Consultation' THEN appointment_log.from_time END))) as consultation_duration,			   max(bill.total_amount) as collection_amount   FROM  %db_prefix%appointments as appointment       LEFT JOIN %db_prefix%view_patient as view_patient ON appointment.patient_id = view_patient.patient_id	   LEFT JOIN %db_prefix%bill as bill ON appointment.visit_id = bill.visit_id	   LEFT JOIN %db_prefix%appointment_log as appointment_log ON appointment.appointment_id = appointment_log.appointment_id	   LEFT JOIN %db_prefix%users AS users ON users.userid = appointment.userid        LEFT JOIN %db_prefix%clinic AS clinic ON clinic.clinic_id = IFNULL(appointment.clinic_id,1)     GROUP BY appointment.appointment_id,patient_name;
UPDATE %dbprefix%version SET current_version='0.5.4';